## 研发设备需求

### 参考数据

#### 阿福客服对话分类项目运行系统
由于该系统每周进行批量分类，相关人员可以等待较长时间的后台自动化处理，所以本地小模型执行的最终分类模块在CPU上运行，工作流前部的语意理解使用OpenAI（ChatGPT）的网络服务处理。

* 阿里云服务器 计算型C7 8核心16G内存，782/月。两台，每月约1500
* 阿里云NAS文件存储服务，100G，约180/月。用于存储模型与用户数据
* 域名等基础服务，挂靠阿福的域名，未产生费用
* 访问流量 阿里云对外流量0.8元/G。定期进行历史数据备份下载可能会产生较为客观的影响
* OpenAI使用费用，客户自己付费，应该十几美金一个月，最近好像又有较大幅度的降价甚至免费。但这一条参考意义不大。和应用设计相关性很大，另外国内的大模型也都是不错的选择，自己在本地运行也是很好的选择

整体而言，运行费用约2000/月 （不含人力成本）。她们每月大约分析几万条记录。

#### 阿福客服对话分类项目研发期间的相关成本
这个项目期间，用到的算力基本是按小时在阿里云租的。一块A10左右的24G显存GPU进行训练，大约20元左右一小时（现在下降了，CPU和内存低一些的有10元左右的）。我整体用了应该不到100小时。
然后，很多时候，代码修改后测试一下效果，是在我家里的苹果上跑的，晚上改完代码睡觉，让它自己慢慢跑。一版代码基本确定了，才去租算力跑完整训练。

#### 阿福法律模型研发设备
因为有本地测试各个大厂大模型基本效果的需求 （但初期生产大模型计划全用大模型API或者月租算力服务器），所以存在本地运行但算力要求并不高的使用需求，合作方给我借了4块A2，（我估计是金主淘汰不用的，但咸鱼每块怎么也5000+吧）。和它匹配，我攒了两台测试机。

* E5 14核心/192G内存/A2*2/SSD （2套）
* 只能进行量化大模型的推理效果验证
* 能进行分类小模型的本地训练
* 能有效帮助进行本地大模型推理的项目研发，以及收集基础数据来估算生产服务器的算力需求

#### 法律模型项目初期的选择，很可能选择大模型全用API，本地跑一些小模型
* 32核、128G、1TSSD，V100以上计算卡*2，共4套
* 用于服务初期1000到10万用户的区间，带HA配置
* 大模型API调用、网络流量和基础服务等浮动成本

### 建议本项目的设备
考虑到本项目输入是音频文件，生产系统的音频处理建议选择本地模型。音频分析的模型相对语言模型要小得多，而音频文件又很大，两相结合，使用本地模型大概率能比使用API整体便宜。语言模型初期还是考虑调用API划算一些，除非客户可以接受缓慢的批量分类。

#### 推荐生产系统
* 32核、128G、1TSSD，V100以上计算卡*2，共4套
* 互联网访问入口与流量
* DNS等基础配置、备案等基础流程服务

#### 便宜点儿，低端种子用户测试系统
* 16核、64G、256GSSD，A10以上计算卡，共3套
* 2T共享存储（NAS/NFS等），单独加盘在其中一个节点上也可以

#### 实在不行，不带高可用的生产系统 （不推荐）
* 64核、192G、1TSSD，A10以上计算卡， 一台
* 3T共享存储，不能插盘在生产服务器上，避免一起死

#### 超低研发服务器配置 （基本就是给亚春玩）
* 32核、128G、256SSD，A10以上计算卡， 一台
* 4T以上hdd，或共享nas

#### 实在不行，捐2/3万块钱
* 配一台带4090的台式机放办公室

=====

# 本Demo用法

## 直接运行
所有数据初始化和占位用分类模型已经包含，可直接运行：

~~~bash
streamlit run demo.py
~~~
按提示安装缺失python包。我提供了最新的requirements.txt但不建议偷懒使用，这里面有很多不必要的包。

按照提示在浏览器访问。请首先使用A831-AD-0D07231A10E449B.mp3进行测试。

## 数据重新初始化

0. 删除现存数据 

~~~bash
rm data/alldata.pkl
rm models/cls/model.pch
~~~

1. 客户训练数据导入

~~~bash
python data.py
~~~

2. mp3语音识别

~~~bash
python stt.py
~~~

3. 语音分析

~~~bash
python llm.py
~~~

4. 批量词嵌入

~~~bash
python embed.py
~~~

5. 模型训练

~~~bash
python cls.py
~~~

6. 运行系统

~~~bash
streamlit run demo.py
~~~

## 已知bug

#### stt调用ffmpeg转换mp3到pcm，客户提供的部分文件（主要是大文件）会出错

#### 分类模型并未进行针对性设计，目前基本无效




